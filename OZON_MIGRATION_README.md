# Миграция структуры продаж и заказов Ozon

## Что изменилось

### 1. Новая структура данных

- **ozon_sales** - теперь хранит ПРОДАЖИ из Finance API (`/v3/finance/transaction/list`)
  - Содержит финансовые транзакции с `operation_type = "OperationAgentDeliveredToCustomer"`
  - `price` = `accruals_for_sale` (начисления за продажу)
  - `status` = 'delivered' (продажа уже совершена)

- **ozon_orders** - новая таблица для хранения ЗАКАЗОВ из Posting API (`/v2/posting/fbo/list` и `/v3/posting/fbs/list`)
  - Содержит постинги (FBS/FBO заказы)
  - `price` = цена товара из posting
  - `status` = статус постинга (awaiting_packaging, delivering, delivered, cancelled и т.д.)

### 2. Обновленная логика datacollector

#### Сбор заказов (`collect_orders`):
- Использует `/v3/posting/fbs/list` для FBS заказов
- Использует `/v2/posting/fbo/list` для FBO заказов
- Сохраняет в таблицу `ozon_orders`
- При первой синхронизации:
  - Сначала пробует собрать с даты первой поставки (максимум 180 дней назад)
  - Если API вернет ошибку, автоматически переключается на 90 дней
  - Использует тестовый запрос для проверки доступности диапазона дат

#### Сбор продаж (`collect_sales`):
- Использует `/v3/finance/transaction/list` с фильтром `OperationAgentDeliveredToCustomer`
- Сохраняет в таблицу `ozon_sales`
- При первой синхронизации собирает помесячно с даты первой поставки
- Включает пагинацию (1000 записей на страницу)
- Включает retry логику для ошибок 429 (5 попыток, 20 секунд задержка)

### 3. Обновленные сервисы

`sales_service.py` теперь:
- Использует `ozon_orders` для заказов
- Использует `ozon_sales` для продаж
- Поддерживает фильтрацию по датам для обеих таблиц

## Инструкция по миграции

### Шаг 1: Запуск миграции

```bash
./venv/Scripts/python.exe migrate_ozon_sales.py
```

Этот скрипт:
1. Создаст таблицу `ozon_orders`
2. Очистит таблицу `ozon_sales` (старые данные о заказах будут удалены)

### Шаг 2: Запуск datacollector

После миграции запустите datacollector для заполнения таблиц новыми данными:

```bash
# Datacollector автоматически определит, что таблицы пусты, и выполнит первичную синхронизацию:
# - ozon_orders: заказы с даты первой поставки (пробует 180 дней, при ошибке - 90 дней)
# - ozon_sales: продажи помесячно с даты первой поставки (через Finance API без ограничений)
```

**Умная логика сбора заказов:**
- Datacollector сначала пытается запросить 180 дней истории заказов
- Если API Ozon вернет ошибку (превышен лимит), автоматически переключается на 90 дней
- Продажи собираются без ограничений с самого начала работы

### Шаг 3: Мониторинг

Проверьте логи datacollector на наличие ошибок. Обратите внимание на:
- Количество собранных заказов
- Количество собранных продаж
- Наличие ошибок 429 (rate limiting)

## Важные замечания

1. **Таблица ozon_sales будет полностью очищена** - это необходимо, так как старая структура содержала заказы, а не продажи

2. **Первая синхронизация может занять время** - datacollector будет собирать продажи помесячно с даты первой поставки

3. **Rate limiting** - Finance API имеет ограничения на количество запросов. Datacollector автоматически обрабатывает ошибки 429 с retry логикой

4. **Данные о продажах более точные** - Finance API предоставляет реальные начисления за продажи (`accruals_for_sale`), а не просто цену товара

## Структура полей

### ozon_sales (продажи)
- `posting_number` - номер постинга
- `price` - начисления за продажу (accruals_for_sale)
- `payout` - выплата (amount)
- `shipment_date` - дата операции
- `status` - всегда 'delivered'

### ozon_orders (заказы)
- `posting_number` - номер постинга
- `price` - цена товара
- `shipment_date` - дата отгрузки
- `status` - статус постинга (awaiting_packaging, delivering, delivered, cancelled и т.д.)
- `delivery_schema` - тип доставки (FBS/FBO)
