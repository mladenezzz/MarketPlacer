# Логика расчёта еженедельного отчёта Wildberries

## Исходный файл
**"Отчет продаж.xlsx"** — еженедельный детализированный отчёт продавца WB (72 колонки).

## Ключевые колонки
- `Тип документа` — "Продажа", "Возврат", или пусто (для логистики/хранения)
- `Артикул поставщика` — артикул товара
- `К перечислению Продавцу за реализованный Товар` — сумма к перечислению (для продаж положительная, для возвратов тоже положительная!)
- `Вайлдберриз реализовал Товар (Пр)` — сумма реализации
- `Услуги по доставке товара покупателю` — логистика
- `Хранение` — стоимость хранения
- `Удержания` — прочие удержания
- `Общая сумма штрафов` — штрафы
- `Компенсация скидки по программе лояльности` — уже включена в "К перечислению"

## ВАЖНО: Возвраты имеют положительный знак!
В файле WB возвраты записаны с **положительными** значениями в колонке "К перечислению".
Поэтому нужно **вычитать** возвраты из продаж вручную:

```python
sales = df[df['Тип документа'] == 'Продажа']['К перечислению Продавцу за реализованный Товар'].sum()
returns = df[df['Тип документа'] == 'Возврат']['К перечислению Продавцу за реализованный Товар'].sum()
к_перечислению = sales - returns  # НЕ sum(), а именно разница!
```

## Формула расчёта "Итого к оплате"

```
Итого к оплате = К перечислению за товар - Логистика - Хранение - Удержания - Штрафы
```

Где:
- **К перечислению за товар** = Сумма продаж - Сумма возвратов (из колонки "К перечислению Продавцу за реализованный Товар")
- **Логистика** = sum("Услуги по доставке товара покупателю")
- **Хранение** = sum("Хранение")
- **Удержания** = sum("Удержания")
- **Штрафы** = sum("Общая сумма штрафов")

**Компенсация лояльности** уже включена в "К перечислению за товар", отдельно не прибавляется!

## Пример расчёта (проверенные данные)

| Показатель | Сумма |
|------------|-------|
| Продажи (К перечислению) | 747,148.38 |
| Возвраты (К перечислению) | -45,088.15 |
| **К перечислению за товар** | **702,060.23** |
| Логистика | -191,887.09 |
| После логистики | 510,173.14 |
| Хранение | -2,310.76 |
| Удержания | -25,633.00 |
| Штрафы | -20.00 |
| **ИТОГО К ОПЛАТЕ** | **482,209.38** |

## Группировка по артикулам

При группировке по артикулам логистика распределяется **пропорционально реализации**, т.к. в исходных данных логистика не привязана напрямую к артикулу.

```python
grouped['Логистика'] = grouped['Реализация'] / total_realization * total_logistics
grouped['Итого'] = grouped['К_перечислению'] - grouped['Логистика']
```

## Количество продаж/возвратов

- **Продаж** = количество записей с типом "Продажа"
- **Возвратов** = количество записей с типом "Возврат"
- **Чистых продаж** = Продаж - Возвратов (реально осталось у покупателей)

## Скрипт анализа

Готовый скрипт: `z:\analyze_orders.py`

Создаёт файл `z:\Анализ_по_артикулам.xlsx` с тремя листами:
1. **По артикулам** — разбивка по артикулам с продажами, возвратами, логистикой, итого
2. **Прочие расходы** — хранение, удержания, штрафы
3. **Итоговый расчет** — финальная сводка с формулой
