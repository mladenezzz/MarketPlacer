{% extends "base.html" %}

{% block title %}VLESS/Reality - MarketPlacer{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">
                            <i class="bi bi-shield-lock"></i> VLESS/Reality
                        </h3>
                        <a href="{{ url_for('vpn.add_vless_user') }}" class="btn btn-light">
                            <i class="bi bi-plus-lg"></i> Добавить пользователя
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <div class="alert {% if vps_status and vps_status.is_active %}alert-success{% else %}alert-warning{% endif %} mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-hdd-network"></i>
                                        <strong>Сервер:</strong> {{ server_ip }}:443 |
                                        <strong>Статус Xray:</strong>
                                        {% if vps_status and vps_status.is_active %}
                                            <span class="badge bg-success">Работает</span>
                                            {% if vps_status.info and vps_status.info.version %}
                                                <small class="text-muted ms-2">{{ vps_status.info.version }}</small>
                                            {% endif %}
                                        {% elif vps_status and vps_status.error %}
                                            <span class="badge bg-danger">Ошибка подключения</span>
                                            <small class="text-muted ms-2">{{ vps_status.error }}</small>
                                        {% else %}
                                            <span class="badge bg-warning">Не запущен</span>
                                        {% endif %}
                                    </div>
                                    <form method="POST" action="{{ url_for('vpn.sync_vless_config') }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-primary" id="syncBtn">
                                            <i class="bi bi-arrow-repeat"></i> Синхронизировать
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <p class="text-muted mb-4">
                            Всего пользователей: <strong>{{ users|length }}</strong>
                        </p>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Имя</th>
                                        <th>Режим доступа</th>
                                        <th>Трафик</th>
                                        <th>Последнее использование</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                    <tr {% if not user.is_active %}class="table-secondary"{% endif %}>
                                        <td>
                                            <i class="bi bi-person-badge"></i>
                                            {{ user.name }}
                                        </td>
                                        <td>
                                            {% if user.access_mode == 'full' %}
                                                <span class="badge bg-success">
                                                    <i class="bi bi-globe"></i> Полный
                                                </span>
                                            {% elif user.access_mode == 'lan_only' %}
                                                <span class="badge bg-warning text-dark">
                                                    <i class="bi bi-hdd-network"></i> Только LAN
                                                </span>
                                            {% else %}
                                                <span class="badge bg-primary">
                                                    <i class="bi bi-cloud"></i> Только Интернет
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>{{ user.get_traffic_display() }}</td>
                                        <td>
                                            {% if user.last_used_at %}
                                                {{ user.last_used_at.strftime('%d.%m.%Y %H:%M') }}
                                            {% else %}
                                                <span class="text-muted">Не использовался</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if user.is_active %}
                                                <span class="badge bg-success">
                                                    <i class="bi bi-check-circle"></i> Активен
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">
                                                    <i class="bi bi-x-circle"></i> Отключён
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button"
                                                        class="btn btn-sm btn-info copy-link-btn"
                                                        data-user-id="{{ user.id }}"
                                                        title="Копировать ссылку">
                                                    <i class="bi bi-link-45deg"></i>
                                                </button>
                                                <button type="button"
                                                        class="btn btn-sm btn-secondary show-qr-btn"
                                                        data-user-id="{{ user.id }}"
                                                        title="Показать QR-код">
                                                    <i class="bi bi-qr-code"></i>
                                                </button>
                                                <a href="{{ url_for('vpn.edit_vless_user', user_id=user.id) }}"
                                                   class="btn btn-sm btn-primary"
                                                   title="Редактировать">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <form method="POST" action="{{ url_for('vpn.toggle_vless_user', user_id=user.id) }}" style="display: inline;">
                                                    {% if user.is_active %}
                                                        <button type="submit" class="btn btn-sm btn-warning" title="Отключить">
                                                            <i class="bi bi-pause"></i>
                                                        </button>
                                                    {% else %}
                                                        <button type="submit" class="btn btn-sm btn-success" title="Включить">
                                                            <i class="bi bi-play"></i>
                                                        </button>
                                                    {% endif %}
                                                </form>
                                                <form method="POST" action="{{ url_for('vpn.delete_vless_user', user_id=user.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-danger" title="Удалить"
                                                            onclick="return confirm('Удалить пользователя {{ user.name }}?')">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                                            <p class="mt-2">Пользователи не найдены</p>
                                            <a href="{{ url_for('vpn.add_vless_user') }}" class="btn btn-primary">
                                                <i class="bi bi-plus-lg"></i> Добавить первого пользователя
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4">
                            <form method="POST" action="{{ url_for('vpn.import_vless_users') }}" class="d-inline">
                                <button type="submit" class="btn btn-outline-success">
                                    <i class="bi bi-cloud-download"></i> Импорт с VPS
                                </button>
                            </form>
                            <a href="{{ url_for('vpn.export_xray_config') }}" class="btn btn-outline-primary" target="_blank">
                                <i class="bi bi-download"></i> Экспорт конфига Xray
                            </a>
                            <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Назад
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для QR-кода -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-qr-code"></i> QR-код для <span id="qrUserName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrcode" style="display: inline-block;"></div>
                <div class="mt-3">
                    <small class="text-muted">Отсканируйте в v2rayNG, Shadowrocket или Nekobox</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveQrBtn" style="display: none;">
                    <i class="bi bi-download"></i> Сохранить QR-код
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
    .table-responsive {
        border-radius: 10px;
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
    }

    .badge {
        font-weight: 500;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }

    .btn-group {
        display: inline-flex;
        gap: 5px;
    }

    .btn-group form {
        margin: 0;
    }

    tr.table-secondary {
        opacity: 0.7;
    }

    #qrcode {
        padding: 15px;
        background: white;
        border-radius: 10px;
    }
</style>
{% endblock %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция копирования в буфер обмена (работает без HTTPS)
    function copyToClipboard(text) {
        // Пробуем использовать современный API если доступен
        if (navigator.clipboard && window.isSecureContext) {
            return navigator.clipboard.writeText(text);
        } else {
            // Fallback для HTTP соединений
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            return new Promise((resolve, reject) => {
                try {
                    document.execCommand('copy');
                    textArea.remove();
                    resolve();
                } catch (err) {
                    textArea.remove();
                    reject(err);
                }
            });
        }
    }

    // Копирование ссылки
    document.querySelectorAll('.copy-link-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            fetch(`/server/vless/${userId}/link`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    return copyToClipboard(data.link).then(() => {
                        // Показать уведомление
                        const originalHtml = btn.innerHTML;
                        btn.innerHTML = '<i class="bi bi-check"></i>';
                        btn.classList.remove('btn-info');
                        btn.classList.add('btn-success');
                        setTimeout(() => {
                            btn.innerHTML = originalHtml;
                            btn.classList.remove('btn-success');
                            btn.classList.add('btn-info');
                        }, 2000);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ошибка: ' + error.message);
                });
        });
    });

    // Показ QR-кода
    const qrModal = document.getElementById('qrModal');
    const qrContainer = document.getElementById('qrcode');
    const saveQrBtn = document.getElementById('saveQrBtn');
    let qrCode = null;
    let currentUserName = '';

    document.querySelectorAll('.show-qr-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            fetch(`/server/vless/${userId}/link`)
                .then(response => response.json())
                .then(data => {
                    currentUserName = data.name;
                    document.getElementById('qrUserName').textContent = data.name;

                    // Очищаем предыдущий QR-код
                    qrContainer.innerHTML = '';

                    // Создаём новый QR-код
                    qrCode = new QRCode(qrContainer, {
                        text: data.link,
                        width: 256,
                        height: 256,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.M
                    });

                    // Показываем кнопку сохранения
                    saveQrBtn.style.display = 'inline-block';

                    // Показываем модальное окно
                    new bootstrap.Modal(qrModal).show();
                });
        });
    });

    // Сохранение QR-кода
    saveQrBtn.addEventListener('click', function() {
        const canvas = qrContainer.querySelector('canvas');
        if (canvas) {
            // Конвертируем canvas в blob
            canvas.toBlob(function(blob) {
                // Создаем ссылку для скачивания
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentUserName}_qr.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }
    });

    // Скрываем кнопку при закрытии модального окна
    qrModal.addEventListener('hidden.bs.modal', function() {
        saveQrBtn.style.display = 'none';
    });
});
</script>
{% endblock %}
