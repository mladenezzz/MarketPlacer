{% extends "base.html" %}

{% block title %}Статистика выкупов - MarketPlacer{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="bi bi-cart-check"></i> Статистика выкупов
                    </h3>
                </div>
                <div class="card-body">
                    {% if tokens %}
                        <p class="text-muted mb-4">Выберите аккаунты для анализа выкупов:</p>
                        <div class="list-group">
                            {% for token in tokens %}
                                <div class="list-group-item d-flex align-items-center">
                                    <div class="form-check me-3" style="min-width: 20px;">
                                        <input class="form-check-input token-checkbox" type="checkbox"
                                               id="token_{{ token.id }}"
                                               value="{{ token.id }}"
                                               data-token-id="{{ token.id }}"
                                               data-marketplace="{{ token.marketplace }}">
                                    </div>
                                    <div class="me-3" style="min-width: 130px;">
                                        {% if token.marketplace == 'wildberries' %}
                                            <span class="badge bg-purple">
                                                <i class="bi bi-box-seam"></i> {{ token.marketplace_display }}
                                            </span>
                                        {% elif token.marketplace == 'ozon' %}
                                            <span class="badge bg-primary">
                                                <i class="bi bi-box-seam"></i> {{ token.marketplace_display }}
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <strong>{{ token.name }}</strong>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            У вас пока нет добавленных токенов маркетплейсов.
                            <a href="{{ url_for('tokens.add') }}" class="alert-link">Добавить токен</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Фильтр по датам -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar3"></i> Период для отображения данных
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-6">
                            <label for="date-range-picker" class="form-label">Выберите дату или период:</label>
                            <input type="text" class="form-control" id="date-range-picker" placeholder="Все время..." style="background-color: white; cursor: pointer;" readonly>
                        </div>
                        <div class="col-md-6">
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-secondary" id="reset-dates">
                                    <i class="bi bi-infinity"></i> Все время
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="reset-to-week">
                                    <i class="bi bi-calendar-week"></i> Неделя
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="reset-to-month">
                                    <i class="bi bi-calendar-month"></i> Месяц
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if ozon_products %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text"
                                       class="form-control"
                                       id="articleFilter"
                                       placeholder="Поиск по артикулу..."
                                       autocomplete="off">
                            </div>
                        </div>
                        <div class="col-md-6 text-end mt-2 mt-md-0">
                            <small class="text-muted">
                                Показано: <span id="visibleCount">{{ ozon_products|length }}</span> из {{ ozon_products|length }}
                            </small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="article" style="cursor: pointer;">
                                        Артикул <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    <th>Размер</th>
                                    <th class="text-center sortable ozon-stock-col" data-sort="stock" style="cursor: pointer;">
                                        <span style="white-space: pre-line;">Ozon
Остатки</span> <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    <th class="text-center wb-stock-col" data-token-id="{{ wb_token.id }}" style="cursor: default;">
                                        <span style="white-space: pre-line;">WB
{{ wb_token.name }}</span>
                                    </th>
                                    {% endfor %}
                                    <th class="text-center sortable" data-sort="total" style="cursor: pointer;">
                                        Заказано <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    <th class="text-center sortable" data-sort="delivered" style="cursor: pointer;">
                                        Выкуплено <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    <th class="text-center sortable" data-sort="cancelled" style="cursor: pointer;">
                                        Отменено <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    <th class="text-center sortable" data-sort="percent" style="cursor: pointer;">
                                        % выкупа <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for article, size, delivered_count, cancelled_count, stock_count in ozon_products %}
                                {% set total = delivered_count + cancelled_count %}
                                {% set buyout_percent = (delivered_count / total * 100) if total > 0 else 0 %}
                                <tr data-article="{{ article }}" data-size="{{ size }}" data-total="{{ total }}" data-delivered="{{ delivered_count }}" data-cancelled="{{ cancelled_count }}" data-percent="{{ buyout_percent }}" data-stock="{{ stock_count }}">
                                    <td><strong>{{ article }}</strong></td>
                                    <td>{{ size if size else '-' }}</td>
                                    <td class="text-center ozon-stock-col">
                                        <span class="badge bg-secondary">{{ stock_count }}</span>
                                    </td>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    {% set wb_key = article ~ '|' ~ (size if size else '') %}
                                    {% set wb_stock = wb_stocks_by_token.get(wb_token.id, {}).get('stocks', {}).get(wb_key, 0) %}
                                    <td class="text-center wb-stock-col" data-token-id="{{ wb_token.id }}">
                                        <span class="badge bg-purple">{{ wb_stock }}</span>
                                    </td>
                                    {% endfor %}
                                    <td class="text-center">
                                        <span class="badge bg-info">{{ total }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-success">{{ delivered_count }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-danger">{{ cancelled_count }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge {% if buyout_percent >= 80 %}bg-success{% elif buyout_percent >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ "%.1f"|format(buyout_percent) }}%
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <p class="text-muted mt-3 mb-0">
                        <small>Всего уникальных товаров: {{ ozon_products|length }}</small>
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterInput = document.getElementById('articleFilter');
    const tableBody = document.querySelector('table tbody');
    const visibleCount = document.getElementById('visibleCount');
    const totalCount = {{ ozon_products|length }};

    // === Управление видимостью колонок по чекбоксам ===
    const STORAGE_KEY = 'buyouts_token_visibility';
    const tokenCheckboxes = document.querySelectorAll('.token-checkbox');

    // Загрузка сохраненного состояния из localStorage
    function loadTokenVisibility() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try {
                return JSON.parse(saved);
            } catch (e) {
                return null;
            }
        }
        return null;
    }

    // Сохранение состояния в localStorage
    function saveTokenVisibility() {
        const state = {};
        tokenCheckboxes.forEach(checkbox => {
            const tokenId = checkbox.dataset.tokenId;
            state[tokenId] = checkbox.checked;
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // Обновление видимости колонок
    function updateColumnVisibility(tokenId, marketplace, visible) {
        if (marketplace === 'ozon') {
            // Для Ozon скрываем/показываем колонку остатков Ozon
            document.querySelectorAll('.ozon-stock-col').forEach(el => {
                el.style.display = visible ? '' : 'none';
            });
        } else if (marketplace === 'wildberries') {
            // Для WB скрываем/показываем колонку конкретного токена
            document.querySelectorAll(`.wb-stock-col[data-token-id="${tokenId}"]`).forEach(el => {
                el.style.display = visible ? '' : 'none';
            });
        }
    }

    // Инициализация чекбоксов и видимости
    function initTokenVisibility() {
        const savedState = loadTokenVisibility();

        tokenCheckboxes.forEach(checkbox => {
            const tokenId = checkbox.dataset.tokenId;
            const marketplace = checkbox.dataset.marketplace;

            // Устанавливаем состояние чекбокса из сохраненного или по умолчанию (checked)
            if (savedState && savedState.hasOwnProperty(tokenId)) {
                checkbox.checked = savedState[tokenId];
            } else {
                // По умолчанию все включены
                checkbox.checked = true;
            }

            // Применяем видимость
            updateColumnVisibility(tokenId, marketplace, checkbox.checked);

            // Обработчик изменения чекбокса
            checkbox.addEventListener('change', function() {
                updateColumnVisibility(tokenId, marketplace, this.checked);
                saveTokenVisibility();
            });
        });

        // Сохраняем начальное состояние если его не было
        if (!savedState) {
            saveTokenVisibility();
        }
    }

    // Инициализируем видимость токенов
    initTokenVisibility();

    // Функция для получения порядка размера
    function getSizeOrder(size) {
        const sizeOrder = {
            'S': 0, 'M': 1, 'L': 2, 'XL': 3, 'XXL': 4,
            '6': 10, '6.5': 11, '7': 12, '7.5': 13,
            '8': 14, '8.5': 15, '9': 16, '9.5': 17,
            '10': 18, '10.5': 19, '11': 20, '11.5': 21,
            '12': 22, '12.5': 23
        };
        return sizeOrder[size] !== undefined ? sizeOrder[size] : 999;
    }

    // Функция сортировки по артикулу и размеру
    function sortByArticleAndSize() {
        if (!tableBody) return;
        const rows = Array.from(tableBody.querySelectorAll('tr'));
        rows.sort((a, b) => {
            const aArticle = a.dataset.article.toLowerCase();
            const bArticle = b.dataset.article.toLowerCase();
            let result = aArticle.localeCompare(bArticle);
            if (result === 0) {
                const aSize = getSizeOrder(a.dataset.size);
                const bSize = getSizeOrder(b.dataset.size);
                return aSize - bSize;
            }
            return result;
        });
        rows.forEach(row => tableBody.appendChild(row));
    }

    // Сортируем при загрузке страницы
    sortByArticleAndSize();

    // Фильтрация по артикулу
    if (filterInput && tableBody) {
        filterInput.addEventListener('input', function() {
            const filterValue = this.value.toLowerCase().trim();
            const rows = tableBody.querySelectorAll('tr');
            let visibleRows = 0;

            rows.forEach(row => {
                const articleCell = row.querySelector('td:first-child');
                if (articleCell) {
                    const articleText = articleCell.textContent.toLowerCase();

                    // Показываем строку, если артикул начинается с введенного текста
                    if (filterValue === '' || articleText.startsWith(filterValue)) {
                        row.style.display = '';
                        visibleRows++;
                    } else {
                        row.style.display = 'none';
                    }
                }
            });

            // Обновляем счетчик
            if (visibleCount) {
                visibleCount.textContent = visibleRows;
            }
        });

        // Фокус на поле поиска при нажатии Ctrl+F или Cmd+F
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                filterInput.focus();
            }
        });
    }

    // Функция для форматирования даты для API (YYYY-MM-DD)
    function formatDateForAPI(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${year}-${month}-${day}`;
    }

    // Функция для форматирования даты для отображения (DD.MM.YYYY)
    function formatDate(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
    }

    // Функция для перезагрузки страницы с новыми датами
    function reloadWithDates(dateFrom, dateTo) {
        const url = new URL(window.location.href);
        if (dateFrom && dateTo) {
            url.searchParams.set('date_from', formatDateForAPI(dateFrom));
            url.searchParams.set('date_to', formatDateForAPI(dateTo));
        } else {
            url.searchParams.delete('date_from');
            url.searchParams.delete('date_to');
        }
        window.location.href = url.toString();
    }

    // Инициализация Air Datepicker
    const picker = new AirDatepicker('#date-range-picker', {
        range: true,
        multipleDatesSeparator: ' - ',
        dateFormat: 'dd.MM.yyyy',
        autoClose: false,
        maxDate: new Date(),
        buttons: [
            {
                content(dp) {
                    return 'Сбросить';
                },
                onClick(dp) {
                    dp.clear();
                    reloadWithDates(null, null);
                }
            },
            {
                content(dp) {
                    return 'Применить';
                },
                onClick(dp) {
                    const dates = dp.selectedDates;
                    if (dates.length === 2) {
                        reloadWithDates(dates[0], dates[1]);
                    } else if (dates.length === 1) {
                        reloadWithDates(dates[0], dates[0]);
                    }
                }
            }
        ]
    });

    // Обработчик кнопки "Все время"
    document.getElementById('reset-dates').addEventListener('click', function() {
        picker.clear();
        reloadWithDates(null, null);
    });

    // Обработчик кнопки "Неделя"
    document.getElementById('reset-to-week').addEventListener('click', function() {
        const today = new Date();
        const weekAgo = new Date();
        weekAgo.setDate(today.getDate() - 6);
        picker.selectDate([weekAgo, today]);
        reloadWithDates(weekAgo, today);
    });

    // Обработчик кнопки "Месяц"
    document.getElementById('reset-to-month').addEventListener('click', function() {
        const today = new Date();
        const monthAgo = new Date();
        monthAgo.setMonth(today.getMonth() - 1);
        picker.selectDate([monthAgo, today]);
        reloadWithDates(monthAgo, today);
    });

    // Сортировка таблицы
    const table = document.querySelector('table');
    const headers = document.querySelectorAll('th.sortable');
    let currentSort = { column: null, direction: 'asc' };

    headers.forEach(header => {
        header.addEventListener('click', function() {
            const sortKey = this.dataset.sort;
            const icon = this.querySelector('i');

            // Определяем направление сортировки
            if (currentSort.column === sortKey) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = sortKey;
                currentSort.direction = 'asc';
            }

            // Сбрасываем иконки на всех заголовках
            headers.forEach(h => {
                const hIcon = h.querySelector('i');
                hIcon.className = 'bi bi-arrow-down-up text-muted';
            });

            // Устанавливаем иконку для текущего столбца
            if (currentSort.direction === 'asc') {
                icon.className = 'bi bi-arrow-up';
            } else {
                icon.className = 'bi bi-arrow-down';
            }

            // Сортируем строки
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                let aVal, bVal;

                if (sortKey === 'article') {
                    aVal = a.dataset.article.toLowerCase();
                    bVal = b.dataset.article.toLowerCase();
                    let result;
                    if (currentSort.direction === 'asc') {
                        result = aVal.localeCompare(bVal);
                    } else {
                        result = bVal.localeCompare(aVal);
                    }
                    // Если артикулы равны, сортируем по размеру
                    if (result === 0) {
                        const aSize = getSizeOrder(a.dataset.size);
                        const bSize = getSizeOrder(b.dataset.size);
                        return aSize - bSize;
                    }
                    return result;
                } else {
                    aVal = parseFloat(a.dataset[sortKey]) || 0;
                    bVal = parseFloat(b.dataset[sortKey]) || 0;
                    let result;
                    if (currentSort.direction === 'asc') {
                        result = aVal - bVal;
                    } else {
                        result = bVal - aVal;
                    }
                    // Если значения равны, сортируем по артикулу
                    if (result === 0) {
                        const aArticle = a.dataset.article.toLowerCase();
                        const bArticle = b.dataset.article.toLowerCase();
                        return aArticle.localeCompare(bArticle);
                    }
                    return result;
                }
            });

            // Перемещаем строки в новом порядке
            rows.forEach(row => tbody.appendChild(row));
        });
    });
});
</script>
{% endblock %}
