{% extends "base.html" %}

{% block title %}Статистика выкупов - MarketPlacer{% endblock %}

{% block content %}
<div class="container-fluid my-5 px-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="bi bi-cart-check"></i> Статистика выкупов
                    </h3>
                </div>
                <div class="card-body">
                    {% if tokens %}
                        <p class="text-muted mb-4">Выберите аккаунты и колонки для отображения (перетаскивайте для изменения порядка):</p>
                        <div class="list-group" id="token-list">
                            {% for token in tokens %}
                                <div class="list-group-item d-flex align-items-center token-item"
                                     data-token-id="{{ token.id }}"
                                     data-marketplace="{{ token.marketplace }}"
                                     draggable="true"
                                     style="cursor: grab;">
                                    <div class="me-2 text-muted drag-handle">
                                        <i class="bi bi-grip-vertical"></i>
                                    </div>
                                    <div class="me-3" style="min-width: 130px;">
                                        {% if token.marketplace == 'wildberries' %}
                                            <span class="badge bg-purple">
                                                <i class="bi bi-box-seam"></i> {{ token.marketplace_display }}
                                            </span>
                                        {% elif token.marketplace == 'ozon' %}
                                            <span class="badge bg-primary">
                                                <i class="bi bi-box-seam"></i> {{ token.marketplace_display }}
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div class="me-3" style="min-width: 120px;">
                                        <strong>{{ token.name }}</strong>
                                    </div>
                                    <div class="d-flex flex-wrap gap-2">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input column-checkbox" type="checkbox"
                                                   id="col_stock_{{ token.id }}"
                                                   data-token-id="{{ token.id }}"
                                                   data-marketplace="{{ token.marketplace }}"
                                                   data-col-type="stock">
                                            <label class="form-check-label small" for="col_stock_{{ token.id }}">Остатки</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input column-checkbox" type="checkbox"
                                                   id="col_orders_{{ token.id }}"
                                                   data-token-id="{{ token.id }}"
                                                   data-marketplace="{{ token.marketplace }}"
                                                   data-col-type="orders">
                                            <label class="form-check-label small" for="col_orders_{{ token.id }}">Заказы</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input column-checkbox" type="checkbox"
                                                   id="col_delivered_{{ token.id }}"
                                                   data-token-id="{{ token.id }}"
                                                   data-marketplace="{{ token.marketplace }}"
                                                   data-col-type="delivered">
                                            <label class="form-check-label small" for="col_delivered_{{ token.id }}">Выкупы</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input column-checkbox" type="checkbox"
                                                   id="col_cancelled_{{ token.id }}"
                                                   data-token-id="{{ token.id }}"
                                                   data-marketplace="{{ token.marketplace }}"
                                                   data-col-type="cancelled">
                                            <label class="form-check-label small" for="col_cancelled_{{ token.id }}">Отмены</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input column-checkbox" type="checkbox"
                                                   id="col_percent_{{ token.id }}"
                                                   data-token-id="{{ token.id }}"
                                                   data-marketplace="{{ token.marketplace }}"
                                                   data-col-type="percent">
                                            <label class="form-check-label small" for="col_percent_{{ token.id }}">% выкупа</label>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            У вас пока нет добавленных токенов маркетплейсов.
                            <a href="{{ url_for('tokens.add') }}" class="alert-link">Добавить токен</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Фильтр по датам -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar3"></i> Период для отображения данных
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-6">
                            <label for="date-range-picker" class="form-label">Выберите дату или период:</label>
                            <input type="text" class="form-control" id="date-range-picker" placeholder="Все время..." style="background-color: white; cursor: pointer;" readonly>
                        </div>
                        <div class="col-md-6">
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-secondary" id="reset-dates">
                                    <i class="bi bi-infinity"></i> Все время
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="reset-to-week">
                                    <i class="bi bi-calendar-week"></i> Неделя
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="reset-to-month">
                                    <i class="bi bi-calendar-month"></i> Месяц
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if ozon_products %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text"
                                       class="form-control"
                                       id="articleFilter"
                                       placeholder="Поиск по артикулу..."
                                       autocomplete="off">
                            </div>
                        </div>
                        <div class="col-md-6 text-end mt-2 mt-md-0">
                            <button type="button" class="btn btn-success btn-sm me-3" id="exportExcel">
                                <i class="bi bi-file-earmark-excel"></i> Экспорт в Excel
                            </button>
                            <small class="text-muted">
                                Показано: <span id="visibleCount">{{ ozon_products|length }}</span> из {{ ozon_products|length }}
                            </small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                {% set token_cols_count = 1 + (wb_tokens|default([]))|length %}
                                <!-- Первая строка: объединённые заголовки -->
                                <tr>
                                    <th rowspan="3" class="sortable align-middle" data-sort="article" style="cursor: pointer;">
                                        Артикул <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    <th rowspan="3" class="align-middle">Размер</th>
                                    <th colspan="{{ token_cols_count }}" class="text-center" id="stocks-header">
                                        Остатки
                                    </th>
                                    <th colspan="{{ token_cols_count }}" class="text-center" id="orders-header">
                                        Заказано
                                    </th>
                                    <th colspan="{{ token_cols_count }}" class="text-center" id="delivered-header">
                                        Выкуплено
                                    </th>
                                    <th colspan="{{ token_cols_count }}" class="text-center" id="cancelled-header">
                                        Отменено
                                    </th>
                                    <th colspan="{{ token_cols_count }}" class="text-center" id="percent-header">
                                        % выкупа
                                    </th>
                                </tr>
                                <!-- Вторая строка: маркетплейсы -->
                                <tr id="marketplace-row">
                                    <!-- Остатки -->
                                    <th class="text-center ozon-stock-col">Ozon</th>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    <th class="text-center wb-stock-col" data-token-id="{{ wb_token.id }}">WB</th>
                                    {% endfor %}
                                    <!-- Заказано -->
                                    <th class="text-center ozon-orders-col">Ozon</th>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    <th class="text-center wb-orders-col" data-token-id="{{ wb_token.id }}">WB</th>
                                    {% endfor %}
                                    <!-- Выкуплено -->
                                    <th class="text-center ozon-delivered-col">Ozon</th>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    <th class="text-center wb-delivered-col" data-token-id="{{ wb_token.id }}">WB</th>
                                    {% endfor %}
                                    <!-- Отменено -->
                                    <th class="text-center ozon-cancelled-col">Ozon</th>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    <th class="text-center wb-cancelled-col" data-token-id="{{ wb_token.id }}">WB</th>
                                    {% endfor %}
                                    <!-- % выкупа -->
                                    <th class="text-center ozon-percent-col">Ozon</th>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    <th class="text-center wb-percent-col" data-token-id="{{ wb_token.id }}">WB</th>
                                    {% endfor %}
                                </tr>
                                {% set ozon_token_names = ozon_tokens|default([])|map(attribute='name')|join(', ') %}
                                <!-- Третья строка: названия токенов -->
                                <tr id="token-name-row">
                                    <!-- Остатки -->
                                    <th class="text-center sortable ozon-stock-col" data-sort="stock" style="cursor: pointer;">
                                        <small>{{ ozon_token_names or 'Все' }}</small> <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    <th class="text-center sortable wb-stock-col" data-token-id="{{ wb_token.id }}" data-sort="wb_stock_{{ wb_token.id }}" style="cursor: pointer;">
                                        <small>{{ wb_token.name }}</small> <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    {% endfor %}
                                    <!-- Заказано -->
                                    <th class="text-center sortable ozon-orders-col" data-sort="total" style="cursor: pointer;">
                                        <small>{{ ozon_token_names or 'Все' }}</small> <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    <th class="text-center sortable wb-orders-col" data-token-id="{{ wb_token.id }}" data-sort="wb_orders_{{ wb_token.id }}" style="cursor: pointer;">
                                        <small>{{ wb_token.name }}</small> <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    {% endfor %}
                                    <!-- Выкуплено -->
                                    <th class="text-center sortable ozon-delivered-col" data-sort="delivered" style="cursor: pointer;">
                                        <small>{{ ozon_token_names or 'Все' }}</small> <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    <th class="text-center sortable wb-delivered-col" data-token-id="{{ wb_token.id }}" data-sort="wb_delivered_{{ wb_token.id }}" style="cursor: pointer;">
                                        <small>{{ wb_token.name }}</small> <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    {% endfor %}
                                    <!-- Отменено -->
                                    <th class="text-center sortable ozon-cancelled-col" data-sort="cancelled" style="cursor: pointer;">
                                        <small>{{ ozon_token_names or 'Все' }}</small> <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    <th class="text-center sortable wb-cancelled-col" data-token-id="{{ wb_token.id }}" data-sort="wb_cancelled_{{ wb_token.id }}" style="cursor: pointer;">
                                        <small>{{ wb_token.name }}</small> <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    {% endfor %}
                                    <!-- % выкупа -->
                                    <th class="text-center sortable ozon-percent-col" data-sort="percent" style="cursor: pointer;">
                                        <small>{{ ozon_token_names or 'Все' }}</small> <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    <th class="text-center sortable wb-percent-col" data-token-id="{{ wb_token.id }}" data-sort="wb_percent_{{ wb_token.id }}" style="cursor: pointer;">
                                        <small>{{ wb_token.name }}</small> <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for article, size, delivered_count, cancelled_count, stock_count in ozon_products %}
                                {% set total = delivered_count + cancelled_count %}
                                {% set buyout_percent = (delivered_count / total * 100) if total > 0 else 0 %}
                                {% set wb_key = article ~ '|' ~ (size if size else '') %}
                                <tr data-article="{{ article }}" data-size="{{ size }}" data-total="{{ total }}" data-delivered="{{ delivered_count }}" data-cancelled="{{ cancelled_count }}" data-percent="{{ buyout_percent }}" data-stock="{{ stock_count }}"
                                    {% for wb_token in wb_tokens|default([]) %}
                                    {% set wb_data = wb_stocks_by_token.get(wb_token.id, {}) %}
                                    {% set wb_stock = wb_data.get('stocks', {}).get(wb_key, 0) %}
                                    {% set wb_order_data = wb_data.get('orders', {}).get(wb_key, {}) %}
                                    data-wb_stock_{{ wb_token.id }}="{{ wb_stock }}"
                                    data-wb_orders_{{ wb_token.id }}="{{ wb_order_data.get('total', 0) }}"
                                    data-wb_delivered_{{ wb_token.id }}="{{ wb_order_data.get('delivered', 0) }}"
                                    data-wb_cancelled_{{ wb_token.id }}="{{ wb_order_data.get('cancelled', 0) }}"
                                    data-wb_percent_{{ wb_token.id }}="{{ wb_order_data.get('percent', 0) }}"
                                    {% endfor %}>
                                    <td><strong>{{ article }}</strong></td>
                                    <td>{{ size if size else '-' }}</td>
                                    <!-- Остатки -->
                                    <td class="text-center ozon-stock-col">
                                        <span class="badge bg-secondary">{{ stock_count }}</span>
                                    </td>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    {% set wb_stock = wb_stocks_by_token.get(wb_token.id, {}).get('stocks', {}).get(wb_key, 0) %}
                                    <td class="text-center wb-stock-col" data-token-id="{{ wb_token.id }}">
                                        <span class="badge bg-purple">{{ wb_stock }}</span>
                                    </td>
                                    {% endfor %}
                                    <!-- Заказано -->
                                    <td class="text-center ozon-orders-col">
                                        <span class="badge bg-info">{{ total }}</span>
                                    </td>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    {% set wb_order_data = wb_stocks_by_token.get(wb_token.id, {}).get('orders', {}).get(wb_key, {}) %}
                                    <td class="text-center wb-orders-col" data-token-id="{{ wb_token.id }}">
                                        <span class="badge bg-info">{{ wb_order_data.get('total', 0) }}</span>
                                    </td>
                                    {% endfor %}
                                    <!-- Выкуплено -->
                                    <td class="text-center ozon-delivered-col">
                                        <span class="badge bg-success">{{ delivered_count }}</span>
                                    </td>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    {% set wb_order_data = wb_stocks_by_token.get(wb_token.id, {}).get('orders', {}).get(wb_key, {}) %}
                                    <td class="text-center wb-delivered-col" data-token-id="{{ wb_token.id }}">
                                        <span class="badge bg-success">{{ wb_order_data.get('delivered', 0) }}</span>
                                    </td>
                                    {% endfor %}
                                    <!-- Отменено -->
                                    <td class="text-center ozon-cancelled-col">
                                        <span class="badge bg-danger">{{ cancelled_count }}</span>
                                    </td>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    {% set wb_order_data = wb_stocks_by_token.get(wb_token.id, {}).get('orders', {}).get(wb_key, {}) %}
                                    <td class="text-center wb-cancelled-col" data-token-id="{{ wb_token.id }}">
                                        <span class="badge bg-danger">{{ wb_order_data.get('cancelled', 0) }}</span>
                                    </td>
                                    {% endfor %}
                                    <!-- % выкупа -->
                                    <td class="text-center ozon-percent-col">
                                        <span class="badge {% if buyout_percent >= 80 %}bg-success{% elif buyout_percent >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ "%.1f"|format(buyout_percent) }}%
                                        </span>
                                    </td>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    {% set wb_order_data = wb_stocks_by_token.get(wb_token.id, {}).get('orders', {}).get(wb_key, {}) %}
                                    {% set wb_percent = wb_order_data.get('percent', 0) %}
                                    <td class="text-center wb-percent-col" data-token-id="{{ wb_token.id }}">
                                        <span class="badge {% if wb_percent >= 80 %}bg-success{% elif wb_percent >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ "%.1f"|format(wb_percent) }}%
                                        </span>
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <p class="text-muted mt-3 mb-0">
                        <small>Всего уникальных товаров: {{ ozon_products|length }}</small>
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
    .token-item.dragging {
        opacity: 0.5;
        background-color: #e9ecef;
    }
    .token-item.drag-over {
        border-top: 3px solid #0d6efd;
    }
    .drag-handle {
        cursor: grab;
    }
    .drag-handle:active {
        cursor: grabbing;
    }
    /* Компактная таблица */
    .table th, .table td {
        padding: 0.4rem 0.5rem;
        font-size: 0.875rem;
        white-space: nowrap;
    }
    .table .badge {
        font-size: 0.75rem;
        padding: 0.25em 0.5em;
    }
    .table-responsive {
        overflow-x: auto;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- SheetJS для экспорта в Excel -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterInput = document.getElementById('articleFilter');
    const tableBody = document.querySelector('table tbody');
    const visibleCount = document.getElementById('visibleCount');
    const totalCount = {{ ozon_products|length }};

    // === Управление видимостью колонок по типам для каждого токена ===
    const COLUMNS_STORAGE_KEY = 'buyouts_column_visibility';
    const ORDER_STORAGE_KEY = 'buyouts_token_order';
    const columnCheckboxes = document.querySelectorAll('.column-checkbox');

    // Загрузка сохраненного состояния колонок из localStorage
    function loadColumnVisibility() {
        const saved = localStorage.getItem(COLUMNS_STORAGE_KEY);
        if (saved) {
            try {
                return JSON.parse(saved);
            } catch (e) {
                return null;
            }
        }
        return null;
    }

    // Сохранение состояния колонок в localStorage
    function saveColumnVisibility() {
        const state = {};
        columnCheckboxes.forEach(checkbox => {
            const tokenId = checkbox.dataset.tokenId;
            const colType = checkbox.dataset.colType;
            const key = `${tokenId}_${colType}`;
            state[key] = checkbox.checked;
        });
        localStorage.setItem(COLUMNS_STORAGE_KEY, JSON.stringify(state));
    }

    // Обновление видимости конкретной колонки
    function updateSingleColumnVisibility(tokenId, marketplace, colType, visible) {
        if (marketplace === 'ozon') {
            document.querySelectorAll(`.ozon-${colType}-col`).forEach(el => {
                el.style.display = visible ? '' : 'none';
            });
        } else if (marketplace === 'wildberries') {
            document.querySelectorAll(`.wb-${colType}-col[data-token-id="${tokenId}"]`).forEach(el => {
                el.style.display = visible ? '' : 'none';
            });
        }
        // Обновляем colspan заголовка этого типа
        updateAllHeaderColspans();
    }

    // Обновление colspan для конкретного типа заголовка
    function updateHeaderColspan(headerId, colClass) {
        const header = document.getElementById(headerId);
        if (!header) return;

        const marketplaceRow = document.getElementById('marketplace-row');
        if (!marketplaceRow) return;

        // Считаем видимые колонки данного типа
        const allCols = marketplaceRow.querySelectorAll(`.ozon-${colClass}-col, .wb-${colClass}-col`);
        let visibleColsCount = 0;
        allCols.forEach(col => {
            if (col.style.display !== 'none') {
                visibleColsCount++;
            }
        });

        if (visibleColsCount > 0) {
            header.colSpan = visibleColsCount;
            header.style.display = '';
        } else {
            header.style.display = 'none';
        }
    }

    // Обновление colspan всех заголовков
    function updateAllHeaderColspans() {
        // Маппинг: id заголовка -> класс колонок
        const headerMapping = {
            'stocks-header': 'stock',
            'orders-header': 'orders',
            'delivered-header': 'delivered',
            'cancelled-header': 'cancelled',
            'percent-header': 'percent'
        };
        Object.entries(headerMapping).forEach(([headerId, colClass]) => {
            updateHeaderColspan(headerId, colClass);
        });
    }

    // Инициализация чекбоксов колонок
    function initColumnVisibility() {
        const savedState = loadColumnVisibility();

        columnCheckboxes.forEach(checkbox => {
            const tokenId = checkbox.dataset.tokenId;
            const marketplace = checkbox.dataset.marketplace;
            const colType = checkbox.dataset.colType;
            const key = `${tokenId}_${colType}`;

            // Устанавливаем состояние чекбокса из сохраненного или по умолчанию (checked)
            if (savedState && savedState.hasOwnProperty(key)) {
                checkbox.checked = savedState[key];
            } else {
                // По умолчанию все включены
                checkbox.checked = true;
            }

            // Применяем видимость
            updateSingleColumnVisibility(tokenId, marketplace, colType, checkbox.checked);

            // Обработчик изменения чекбокса
            checkbox.addEventListener('change', function() {
                updateSingleColumnVisibility(tokenId, marketplace, colType, this.checked);
                saveColumnVisibility();
                updateEmptyRowsVisibility();
            });
        });

        // Сохраняем начальное состояние если его не было
        if (!savedState) {
            saveColumnVisibility();
        }
    }

    // Функция для скрытия строк, где все видимые значения равны 0
    function updateEmptyRowsVisibility() {
        if (!tableBody) return;

        const rows = tableBody.querySelectorAll('tr');
        let visibleRows = 0;

        rows.forEach(row => {
            // Получаем видимые колонки
            const visibleColumns = getVisibleColumnsForRow();

            // Проверяем, есть ли хотя бы одно ненулевое значение
            let hasNonZeroValue = false;
            visibleColumns.forEach(col => {
                const value = parseFloat(row.dataset[col.dataKey]) || 0;
                if (value !== 0) {
                    hasNonZeroValue = true;
                }
            });

            // Также проверяем фильтр по артикулу
            const filterValue = filterInput ? filterInput.value.toLowerCase().trim() : '';
            const articleText = row.dataset.article ? row.dataset.article.toLowerCase() : '';
            const matchesFilter = filterValue === '' || articleText.startsWith(filterValue);

            // Показываем строку только если есть данные и соответствует фильтру
            if (hasNonZeroValue && matchesFilter) {
                row.style.display = '';
                visibleRows++;
            } else {
                row.style.display = 'none';
            }
        });

        // Обновляем счетчик
        if (visibleCount) {
            visibleCount.textContent = visibleRows;
        }
    }

    // Получение видимых колонок для проверки строк
    function getVisibleColumnsForRow() {
        const columns = [];

        columnCheckboxes.forEach(checkbox => {
            if (!checkbox.checked) return;

            const tokenId = checkbox.dataset.tokenId;
            const marketplace = checkbox.dataset.marketplace;
            const colType = checkbox.dataset.colType;

            let dataKey;
            if (marketplace === 'ozon') {
                switch (colType) {
                    case 'stock': dataKey = 'stock'; break;
                    case 'orders': dataKey = 'total'; break;
                    case 'delivered': dataKey = 'delivered'; break;
                    case 'cancelled': dataKey = 'cancelled'; break;
                    case 'percent': dataKey = 'percent'; break;
                }
            } else if (marketplace === 'wildberries') {
                dataKey = `wb_${colType}_${tokenId}`;
            }

            columns.push({ dataKey: dataKey });
        });

        return columns;
    }

    // Инициализируем видимость колонок
    initColumnVisibility();

    // Скрываем пустые строки после инициализации
    updateEmptyRowsVisibility();

    // === Drag and Drop для изменения порядка токенов ===
    const tokenList = document.getElementById('token-list');
    const tokenItems = tokenList ? tokenList.querySelectorAll('.token-item') : [];
    let draggedItem = null;

    // Загрузка сохраненного порядка
    function loadTokenOrder() {
        const saved = localStorage.getItem(ORDER_STORAGE_KEY);
        if (saved) {
            try {
                return JSON.parse(saved);
            } catch (e) {
                return null;
            }
        }
        return null;
    }

    // Сохранение порядка токенов
    function saveTokenOrder() {
        if (!tokenList) return;
        const items = tokenList.querySelectorAll('.token-item');
        const order = Array.from(items).map(item => item.dataset.tokenId);
        localStorage.setItem(ORDER_STORAGE_KEY, JSON.stringify(order));
    }

    // Применение сохраненного порядка к списку токенов
    function applyTokenOrder() {
        if (!tokenList) return;
        const savedOrder = loadTokenOrder();
        if (!savedOrder) return;

        const items = Array.from(tokenList.querySelectorAll('.token-item'));
        const orderedItems = [];

        // Сначала добавляем элементы в сохраненном порядке
        savedOrder.forEach(tokenId => {
            const item = items.find(i => i.dataset.tokenId === tokenId);
            if (item) {
                orderedItems.push(item);
            }
        });

        // Добавляем оставшиеся элементы (новые токены)
        items.forEach(item => {
            if (!orderedItems.includes(item)) {
                orderedItems.push(item);
            }
        });

        // Перестраиваем DOM
        orderedItems.forEach(item => tokenList.appendChild(item));
    }

    // Обновление порядка колонок в таблице для определенного типа
    function reorderColumnsForType(colType, tokenOrder, rows) {
        const marketplaceRow = document.getElementById('marketplace-row');
        const tokenNameRow = document.getElementById('token-name-row');

        if (!marketplaceRow || !tokenNameRow) return;

        // Собираем все колонки данного типа
        const columns = [];

        // Ozon колонка
        const ozonMpHeader = marketplaceRow.querySelector(`.ozon-${colType}-col`);
        const ozonTkHeader = tokenNameRow.querySelector(`.ozon-${colType}-col`);
        if (ozonMpHeader && ozonTkHeader) {
            columns.push({
                type: 'ozon',
                marketplaceHeader: ozonMpHeader,
                tokenHeader: ozonTkHeader,
                cells: Array.from(rows).map(row => row.querySelector(`.ozon-${colType}-col`))
            });
        }

        // WB колонки
        tokenOrder.filter(t => t.marketplace === 'wildberries').forEach(token => {
            const mpHeader = marketplaceRow.querySelector(`.wb-${colType}-col[data-token-id="${token.id}"]`);
            const tkHeader = tokenNameRow.querySelector(`.wb-${colType}-col[data-token-id="${token.id}"]`);
            if (mpHeader && tkHeader) {
                columns.push({
                    type: 'wb',
                    tokenId: token.id,
                    marketplaceHeader: mpHeader,
                    tokenHeader: tkHeader,
                    cells: Array.from(rows).map(row =>
                        row.querySelector(`.wb-${colType}-col[data-token-id="${token.id}"]`)
                    )
                });
            }
        });

        // Переупорядочиваем колонки согласно порядку токенов
        const orderedColumns = [];
        tokenOrder.forEach(token => {
            if (token.marketplace === 'ozon') {
                const col = columns.find(c => c.type === 'ozon');
                if (col && !orderedColumns.includes(col)) {
                    orderedColumns.push(col);
                }
            } else if (token.marketplace === 'wildberries') {
                const col = columns.find(c => c.type === 'wb' && c.tokenId === token.id);
                if (col && !orderedColumns.includes(col)) {
                    orderedColumns.push(col);
                }
            }
        });

        return orderedColumns;
    }

    // Обновление порядка колонок в таблице
    function reorderTableColumns() {
        if (!tokenList || !tableBody) return;

        const table = document.querySelector('table');
        if (!table) return;

        const marketplaceRow = document.getElementById('marketplace-row');
        const tokenNameRow = document.getElementById('token-name-row');
        const rows = table.querySelectorAll('tbody tr');

        if (!marketplaceRow || !tokenNameRow) return;

        // Получаем текущий порядок токенов
        const tokenOrder = Array.from(tokenList.querySelectorAll('.token-item'))
            .map(item => ({
                id: item.dataset.tokenId,
                marketplace: item.dataset.marketplace
            }));

        // Типы колонок в порядке их расположения
        const colTypes = ['stock', 'orders', 'delivered', 'cancelled', 'percent'];

        // Для каждого типа переупорядочиваем колонки
        colTypes.forEach(colType => {
            const orderedColumns = reorderColumnsForType(colType, tokenOrder, rows);

            // Вставляем колонки в правильном порядке
            orderedColumns.forEach(col => {
                // Перемещаем заголовки
                marketplaceRow.appendChild(col.marketplaceHeader);
                tokenNameRow.appendChild(col.tokenHeader);
                // Перемещаем ячейки в tbody
                col.cells.forEach((cell, idx) => {
                    if (cell && rows[idx]) {
                        rows[idx].appendChild(cell);
                    }
                });
            });
        });
    }

    // Инициализация drag and drop
    if (tokenList && tokenItems.length > 0) {
        tokenItems.forEach(item => {
            item.addEventListener('dragstart', function(e) {
                draggedItem = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            item.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                document.querySelectorAll('.token-item').forEach(i => i.classList.remove('drag-over'));
                draggedItem = null;
                saveTokenOrder();
                reorderTableColumns();
            });

            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                if (this !== draggedItem) {
                    this.classList.add('drag-over');
                }
            });

            item.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });

            item.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                if (draggedItem && this !== draggedItem) {
                    const allItems = Array.from(tokenList.querySelectorAll('.token-item'));
                    const draggedIndex = allItems.indexOf(draggedItem);
                    const targetIndex = allItems.indexOf(this);

                    if (draggedIndex < targetIndex) {
                        tokenList.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        tokenList.insertBefore(draggedItem, this);
                    }
                }
            });
        });

        // Применяем сохраненный порядок при загрузке
        applyTokenOrder();
        reorderTableColumns();
    }

    // Функция для получения порядка размера
    function getSizeOrder(size) {
        const sizeOrder = {
            'S': 0, 'M': 1, 'L': 2, 'XL': 3, 'XXL': 4,
            '6': 10, '6.5': 11, '7': 12, '7.5': 13,
            '8': 14, '8.5': 15, '9': 16, '9.5': 17,
            '10': 18, '10.5': 19, '11': 20, '11.5': 21,
            '12': 22, '12.5': 23
        };
        return sizeOrder[size] !== undefined ? sizeOrder[size] : 999;
    }

    // Естественная сортировка для артикулов (2089090018-1, 2089090018-2, 2089090018-11)
    function naturalCompare(a, b) {
        const aParts = a.split(/(-?\d+)/);
        const bParts = b.split(/(-?\d+)/);

        for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
            const aPart = aParts[i] || '';
            const bPart = bParts[i] || '';

            // Если обе части - числа, сравниваем как числа
            const aNum = parseInt(aPart, 10);
            const bNum = parseInt(bPart, 10);

            if (!isNaN(aNum) && !isNaN(bNum)) {
                if (aNum !== bNum) {
                    return aNum - bNum;
                }
            } else {
                // Иначе сравниваем как строки
                const cmp = aPart.localeCompare(bPart);
                if (cmp !== 0) {
                    return cmp;
                }
            }
        }
        return 0;
    }

    // Функция сортировки по артикулу и размеру
    function sortByArticleAndSize() {
        if (!tableBody) return;
        const rows = Array.from(tableBody.querySelectorAll('tr'));
        rows.sort((a, b) => {
            const aArticle = a.dataset.article.toLowerCase();
            const bArticle = b.dataset.article.toLowerCase();
            let result = naturalCompare(aArticle, bArticle);
            if (result === 0) {
                const aSize = getSizeOrder(a.dataset.size);
                const bSize = getSizeOrder(b.dataset.size);
                return aSize - bSize;
            }
            return result;
        });
        rows.forEach(row => tableBody.appendChild(row));
    }

    // Сортируем при загрузке страницы
    sortByArticleAndSize();

    // Фильтрация по артикулу
    if (filterInput && tableBody) {
        filterInput.addEventListener('input', function() {
            // Используем общую функцию для обновления видимости строк
            updateEmptyRowsVisibility();
        });

        // Фокус на поле поиска при нажатии Ctrl+F или Cmd+F
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                filterInput.focus();
            }
        });
    }

    // Функция для форматирования даты для API (YYYY-MM-DD)
    function formatDateForAPI(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${year}-${month}-${day}`;
    }

    // Функция для форматирования даты для отображения (DD.MM.YYYY)
    function formatDate(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
    }

    // Функция для перезагрузки страницы с новыми датами
    function reloadWithDates(dateFrom, dateTo) {
        const url = new URL(window.location.href);
        if (dateFrom && dateTo) {
            url.searchParams.set('date_from', formatDateForAPI(dateFrom));
            url.searchParams.set('date_to', formatDateForAPI(dateTo));
        } else {
            url.searchParams.delete('date_from');
            url.searchParams.delete('date_to');
        }
        window.location.href = url.toString();
    }

    // Инициализация Air Datepicker
    const picker = new AirDatepicker('#date-range-picker', {
        range: true,
        multipleDatesSeparator: ' - ',
        dateFormat: 'dd.MM.yyyy',
        autoClose: false,
        maxDate: new Date(),
        buttons: [
            {
                content(dp) {
                    return 'Сбросить';
                },
                onClick(dp) {
                    dp.clear();
                    reloadWithDates(null, null);
                }
            },
            {
                content(dp) {
                    return 'Применить';
                },
                onClick(dp) {
                    const dates = dp.selectedDates;
                    if (dates.length === 2) {
                        reloadWithDates(dates[0], dates[1]);
                    } else if (dates.length === 1) {
                        reloadWithDates(dates[0], dates[0]);
                    }
                }
            }
        ]
    });

    // Обработчик кнопки "Все время"
    document.getElementById('reset-dates').addEventListener('click', function() {
        picker.clear();
        reloadWithDates(null, null);
    });

    // Обработчик кнопки "Неделя"
    document.getElementById('reset-to-week').addEventListener('click', function() {
        const today = new Date();
        const weekAgo = new Date();
        weekAgo.setDate(today.getDate() - 6);
        picker.selectDate([weekAgo, today]);
        reloadWithDates(weekAgo, today);
    });

    // Обработчик кнопки "Месяц"
    document.getElementById('reset-to-month').addEventListener('click', function() {
        const today = new Date();
        const monthAgo = new Date();
        monthAgo.setMonth(today.getMonth() - 1);
        picker.selectDate([monthAgo, today]);
        reloadWithDates(monthAgo, today);
    });

    // Сортировка таблицы
    const table = document.querySelector('table');
    const headers = document.querySelectorAll('th.sortable');
    let currentSort = { column: null, direction: 'asc' };

    headers.forEach(header => {
        header.addEventListener('click', function() {
            const sortKey = this.dataset.sort;
            const icon = this.querySelector('i');

            // Определяем направление сортировки
            if (currentSort.column === sortKey) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = sortKey;
                currentSort.direction = 'asc';
            }

            // Сбрасываем иконки на всех заголовках
            headers.forEach(h => {
                const hIcon = h.querySelector('i');
                hIcon.className = 'bi bi-arrow-down-up text-muted';
            });

            // Устанавливаем иконку для текущего столбца
            if (currentSort.direction === 'asc') {
                icon.className = 'bi bi-arrow-up';
            } else {
                icon.className = 'bi bi-arrow-down';
            }

            // Сортируем строки
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                let aVal, bVal;

                if (sortKey === 'article') {
                    aVal = a.dataset.article.toLowerCase();
                    bVal = b.dataset.article.toLowerCase();
                    let result;
                    if (currentSort.direction === 'asc') {
                        result = naturalCompare(aVal, bVal);
                    } else {
                        result = naturalCompare(bVal, aVal);
                    }
                    // Если артикулы равны, сортируем по размеру
                    if (result === 0) {
                        const aSize = getSizeOrder(a.dataset.size);
                        const bSize = getSizeOrder(b.dataset.size);
                        return aSize - bSize;
                    }
                    return result;
                } else {
                    aVal = parseFloat(a.dataset[sortKey]) || 0;
                    bVal = parseFloat(b.dataset[sortKey]) || 0;
                    let result;
                    if (currentSort.direction === 'asc') {
                        result = aVal - bVal;
                    } else {
                        result = bVal - aVal;
                    }
                    // Если значения равны, сортируем по артикулу
                    if (result === 0) {
                        const aArticle = a.dataset.article.toLowerCase();
                        const bArticle = b.dataset.article.toLowerCase();
                        return aArticle.localeCompare(bArticle);
                    }
                    return result;
                }
            });

            // Перемещаем строки в новом порядке
            rows.forEach(row => tbody.appendChild(row));
        });
    });

    // === Экспорт в Excel ===
    const exportBtn = document.getElementById('exportExcel');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            exportToExcel();
        });
    }

    function exportToExcel() {
        const table = document.querySelector('table');
        if (!table) return;

        // Получаем видимые колонки на основе чекбоксов
        const visibleColumns = getVisibleColumns();

        // Собираем данные для Excel
        const data = [];

        // Формируем заголовок
        const headerRow = ['Артикул', 'Размер'];
        visibleColumns.forEach(col => {
            headerRow.push(col.label);
        });
        data.push(headerRow);

        // Собираем данные из строк таблицы
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            // Пропускаем скрытые строки (отфильтрованные)
            if (row.style.display === 'none') return;

            const rowData = [];

            // Артикул и размер
            rowData.push(row.dataset.article || '');
            rowData.push(row.dataset.size || '');

            // Данные для каждой видимой колонки
            visibleColumns.forEach(col => {
                const value = row.dataset[col.dataKey];
                if (col.isPercent) {
                    rowData.push(parseFloat(value) || 0);
                } else {
                    rowData.push(parseInt(value) || 0);
                }
            });

            data.push(rowData);
        });

        // Создаем рабочую книгу Excel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_array ? XLSX.utils.aoa_to_sheet(data) : XLSX.utils.aoa_to_sheet(data);

        // Настраиваем ширину колонок
        const colWidths = [{ wch: 20 }, { wch: 10 }];
        visibleColumns.forEach(() => colWidths.push({ wch: 15 }));
        ws['!cols'] = colWidths;

        XLSX.utils.book_append_sheet(wb, ws, 'Статистика выкупов');

        // Формируем имя файла с датой
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 10);
        const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '-');
        const filename = `buyouts_${dateStr}_${timeStr}.xlsx`;

        // Сохраняем файл (автоматически в папку Загрузки)
        XLSX.writeFile(wb, filename);
    }

    function getVisibleColumns() {
        const columns = [];
        const colTypes = ['stock', 'orders', 'delivered', 'cancelled', 'percent'];
        const colLabels = {
            'stock': 'Остатки',
            'orders': 'Заказы',
            'delivered': 'Выкупы',
            'cancelled': 'Отмены',
            'percent': '% выкупа'
        };

        // Проверяем чекбоксы для каждого токена
        columnCheckboxes.forEach(checkbox => {
            if (!checkbox.checked) return;

            const tokenId = checkbox.dataset.tokenId;
            const marketplace = checkbox.dataset.marketplace;
            const colType = checkbox.dataset.colType;

            // Получаем имя токена
            const tokenItem = document.querySelector(`.token-item[data-token-id="${tokenId}"]`);
            const tokenName = tokenItem ? tokenItem.querySelector('strong').textContent : '';

            let dataKey, label;
            if (marketplace === 'ozon') {
                // Для Ozon используем стандартные ключи
                switch (colType) {
                    case 'stock': dataKey = 'stock'; break;
                    case 'orders': dataKey = 'total'; break;
                    case 'delivered': dataKey = 'delivered'; break;
                    case 'cancelled': dataKey = 'cancelled'; break;
                    case 'percent': dataKey = 'percent'; break;
                }
                label = `Ozon ${tokenName} - ${colLabels[colType]}`;
            } else if (marketplace === 'wildberries') {
                // Для WB используем ключи с token_id
                dataKey = `wb_${colType}_${tokenId}`;
                label = `WB ${tokenName} - ${colLabels[colType]}`;
            }

            columns.push({
                tokenId: tokenId,
                marketplace: marketplace,
                colType: colType,
                dataKey: dataKey,
                label: label,
                isPercent: colType === 'percent'
            });
        });

        return columns;
    }
});
</script>
{% endblock %}
