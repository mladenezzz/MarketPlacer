{% extends "base.html" %}

{% block title %}Статистика выкупов - MarketPlacer{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="bi bi-cart-check"></i> Статистика выкупов
                    </h3>
                </div>
                <div class="card-body">
                    {% if tokens %}
                        <p class="text-muted mb-4">Выберите аккаунты для анализа выкупов (перетаскивайте для изменения порядка):</p>
                        <div class="list-group" id="token-list">
                            {% for token in tokens %}
                                <div class="list-group-item d-flex align-items-center token-item"
                                     data-token-id="{{ token.id }}"
                                     data-marketplace="{{ token.marketplace }}"
                                     draggable="true"
                                     style="cursor: grab;">
                                    <div class="me-2 text-muted drag-handle">
                                        <i class="bi bi-grip-vertical"></i>
                                    </div>
                                    <div class="form-check me-3" style="min-width: 20px;">
                                        <input class="form-check-input token-checkbox" type="checkbox"
                                               id="token_{{ token.id }}"
                                               value="{{ token.id }}"
                                               data-token-id="{{ token.id }}"
                                               data-marketplace="{{ token.marketplace }}">
                                    </div>
                                    <div class="me-3" style="min-width: 130px;">
                                        {% if token.marketplace == 'wildberries' %}
                                            <span class="badge bg-purple">
                                                <i class="bi bi-box-seam"></i> {{ token.marketplace_display }}
                                            </span>
                                        {% elif token.marketplace == 'ozon' %}
                                            <span class="badge bg-primary">
                                                <i class="bi bi-box-seam"></i> {{ token.marketplace_display }}
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <strong>{{ token.name }}</strong>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            У вас пока нет добавленных токенов маркетплейсов.
                            <a href="{{ url_for('tokens.add') }}" class="alert-link">Добавить токен</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Фильтр по датам -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar3"></i> Период для отображения данных
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-6">
                            <label for="date-range-picker" class="form-label">Выберите дату или период:</label>
                            <input type="text" class="form-control" id="date-range-picker" placeholder="Все время..." style="background-color: white; cursor: pointer;" readonly>
                        </div>
                        <div class="col-md-6">
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-secondary" id="reset-dates">
                                    <i class="bi bi-infinity"></i> Все время
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="reset-to-week">
                                    <i class="bi bi-calendar-week"></i> Неделя
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="reset-to-month">
                                    <i class="bi bi-calendar-month"></i> Месяц
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if ozon_products %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text"
                                       class="form-control"
                                       id="articleFilter"
                                       placeholder="Поиск по артикулу..."
                                       autocomplete="off">
                            </div>
                        </div>
                        <div class="col-md-6 text-end mt-2 mt-md-0">
                            <small class="text-muted">
                                Показано: <span id="visibleCount">{{ ozon_products|length }}</span> из {{ ozon_products|length }}
                            </small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <!-- Первая строка: объединённые заголовки -->
                                <tr>
                                    <th rowspan="3" class="sortable align-middle" data-sort="article" style="cursor: pointer;">
                                        Артикул <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    <th rowspan="3" class="align-middle">Размер</th>
                                    {% set stock_cols_count = 1 + (wb_tokens|default([]))|length %}
                                    <th colspan="{{ stock_cols_count }}" class="text-center" id="stocks-header">
                                        Остатки
                                    </th>
                                    <th rowspan="3" class="text-center sortable align-middle" data-sort="total" style="cursor: pointer;">
                                        Заказано <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    <th rowspan="3" class="text-center sortable align-middle" data-sort="delivered" style="cursor: pointer;">
                                        Выкуплено <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    <th rowspan="3" class="text-center sortable align-middle" data-sort="cancelled" style="cursor: pointer;">
                                        Отменено <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    <th rowspan="3" class="text-center sortable align-middle" data-sort="percent" style="cursor: pointer;">
                                        % выкупа <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                </tr>
                                <!-- Вторая строка: маркетплейсы -->
                                <tr id="marketplace-row">
                                    <th class="text-center ozon-stock-col">Ozon</th>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    <th class="text-center wb-stock-col" data-token-id="{{ wb_token.id }}">WB</th>
                                    {% endfor %}
                                </tr>
                                <!-- Третья строка: названия токенов -->
                                <tr id="token-name-row">
                                    <th class="text-center sortable ozon-stock-col" data-sort="stock" style="cursor: pointer;">
                                        <small>Все</small> <i class="bi bi-arrow-down-up text-muted"></i>
                                    </th>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    <th class="text-center wb-stock-col" data-token-id="{{ wb_token.id }}">
                                        <small>{{ wb_token.name }}</small>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for article, size, delivered_count, cancelled_count, stock_count in ozon_products %}
                                {% set total = delivered_count + cancelled_count %}
                                {% set buyout_percent = (delivered_count / total * 100) if total > 0 else 0 %}
                                <tr data-article="{{ article }}" data-size="{{ size }}" data-total="{{ total }}" data-delivered="{{ delivered_count }}" data-cancelled="{{ cancelled_count }}" data-percent="{{ buyout_percent }}" data-stock="{{ stock_count }}">
                                    <td><strong>{{ article }}</strong></td>
                                    <td>{{ size if size else '-' }}</td>
                                    <td class="text-center ozon-stock-col">
                                        <span class="badge bg-secondary">{{ stock_count }}</span>
                                    </td>
                                    {% for wb_token in wb_tokens|default([]) %}
                                    {% set wb_key = article ~ '|' ~ (size if size else '') %}
                                    {% set wb_stock = wb_stocks_by_token.get(wb_token.id, {}).get('stocks', {}).get(wb_key, 0) %}
                                    <td class="text-center wb-stock-col" data-token-id="{{ wb_token.id }}">
                                        <span class="badge bg-purple">{{ wb_stock }}</span>
                                    </td>
                                    {% endfor %}
                                    <td class="text-center">
                                        <span class="badge bg-info">{{ total }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-success">{{ delivered_count }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-danger">{{ cancelled_count }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge {% if buyout_percent >= 80 %}bg-success{% elif buyout_percent >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ "%.1f"|format(buyout_percent) }}%
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <p class="text-muted mt-3 mb-0">
                        <small>Всего уникальных товаров: {{ ozon_products|length }}</small>
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
    .token-item.dragging {
        opacity: 0.5;
        background-color: #e9ecef;
    }
    .token-item.drag-over {
        border-top: 3px solid #0d6efd;
    }
    .drag-handle {
        cursor: grab;
    }
    .drag-handle:active {
        cursor: grabbing;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterInput = document.getElementById('articleFilter');
    const tableBody = document.querySelector('table tbody');
    const visibleCount = document.getElementById('visibleCount');
    const totalCount = {{ ozon_products|length }};

    // === Управление видимостью и порядком колонок ===
    const STORAGE_KEY = 'buyouts_token_visibility';
    const ORDER_STORAGE_KEY = 'buyouts_token_order';
    const tokenCheckboxes = document.querySelectorAll('.token-checkbox');

    // Загрузка сохраненного состояния из localStorage
    function loadTokenVisibility() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try {
                return JSON.parse(saved);
            } catch (e) {
                return null;
            }
        }
        return null;
    }

    // Сохранение состояния в localStorage
    function saveTokenVisibility() {
        const state = {};
        tokenCheckboxes.forEach(checkbox => {
            const tokenId = checkbox.dataset.tokenId;
            state[tokenId] = checkbox.checked;
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // Обновление видимости колонок
    function updateColumnVisibility(tokenId, marketplace, visible) {
        if (marketplace === 'ozon') {
            // Для Ozon скрываем/показываем колонку остатков Ozon
            document.querySelectorAll('.ozon-stock-col').forEach(el => {
                el.style.display = visible ? '' : 'none';
            });
        } else if (marketplace === 'wildberries') {
            // Для WB скрываем/показываем колонку конкретного токена
            document.querySelectorAll(`.wb-stock-col[data-token-id="${tokenId}"]`).forEach(el => {
                el.style.display = visible ? '' : 'none';
            });
        }
        // Обновляем colspan заголовка "Остатки"
        updateStocksHeaderColspan();
    }

    // Обновление colspan заголовка "Остатки"
    function updateStocksHeaderColspan() {
        const stocksHeader = document.getElementById('stocks-header');
        if (!stocksHeader) return;

        // Считаем видимые колонки остатков
        const marketplaceRow = document.getElementById('marketplace-row');
        if (!marketplaceRow) return;

        const visibleCols = marketplaceRow.querySelectorAll('th:not([style*="display: none"])');
        const newColspan = visibleCols.length;

        if (newColspan > 0) {
            stocksHeader.colSpan = newColspan;
            stocksHeader.style.display = '';
        } else {
            stocksHeader.style.display = 'none';
        }
    }

    // Инициализация чекбоксов и видимости
    function initTokenVisibility() {
        const savedState = loadTokenVisibility();

        tokenCheckboxes.forEach(checkbox => {
            const tokenId = checkbox.dataset.tokenId;
            const marketplace = checkbox.dataset.marketplace;

            // Устанавливаем состояние чекбокса из сохраненного или по умолчанию (checked)
            if (savedState && savedState.hasOwnProperty(tokenId)) {
                checkbox.checked = savedState[tokenId];
            } else {
                // По умолчанию все включены
                checkbox.checked = true;
            }

            // Применяем видимость
            updateColumnVisibility(tokenId, marketplace, checkbox.checked);

            // Обработчик изменения чекбокса
            checkbox.addEventListener('change', function() {
                updateColumnVisibility(tokenId, marketplace, this.checked);
                saveTokenVisibility();
            });
        });

        // Сохраняем начальное состояние если его не было
        if (!savedState) {
            saveTokenVisibility();
        }
    }

    // Инициализируем видимость токенов
    initTokenVisibility();

    // === Drag and Drop для изменения порядка токенов ===
    const tokenList = document.getElementById('token-list');
    const tokenItems = tokenList ? tokenList.querySelectorAll('.token-item') : [];
    let draggedItem = null;

    // Загрузка сохраненного порядка
    function loadTokenOrder() {
        const saved = localStorage.getItem(ORDER_STORAGE_KEY);
        if (saved) {
            try {
                return JSON.parse(saved);
            } catch (e) {
                return null;
            }
        }
        return null;
    }

    // Сохранение порядка токенов
    function saveTokenOrder() {
        if (!tokenList) return;
        const items = tokenList.querySelectorAll('.token-item');
        const order = Array.from(items).map(item => item.dataset.tokenId);
        localStorage.setItem(ORDER_STORAGE_KEY, JSON.stringify(order));
    }

    // Применение сохраненного порядка к списку токенов
    function applyTokenOrder() {
        if (!tokenList) return;
        const savedOrder = loadTokenOrder();
        if (!savedOrder) return;

        const items = Array.from(tokenList.querySelectorAll('.token-item'));
        const orderedItems = [];

        // Сначала добавляем элементы в сохраненном порядке
        savedOrder.forEach(tokenId => {
            const item = items.find(i => i.dataset.tokenId === tokenId);
            if (item) {
                orderedItems.push(item);
            }
        });

        // Добавляем оставшиеся элементы (новые токены)
        items.forEach(item => {
            if (!orderedItems.includes(item)) {
                orderedItems.push(item);
            }
        });

        // Перестраиваем DOM
        orderedItems.forEach(item => tokenList.appendChild(item));
    }

    // Обновление порядка колонок в таблице
    function reorderTableColumns() {
        if (!tokenList || !tableBody) return;

        const table = document.querySelector('table');
        if (!table) return;

        const marketplaceRow = document.getElementById('marketplace-row');
        const tokenNameRow = document.getElementById('token-name-row');
        const rows = table.querySelectorAll('tbody tr');

        if (!marketplaceRow || !tokenNameRow) return;

        // Получаем текущий порядок токенов
        const tokenOrder = Array.from(tokenList.querySelectorAll('.token-item'))
            .map(item => ({
                id: item.dataset.tokenId,
                marketplace: item.dataset.marketplace
            }));

        // Собираем все колонки остатков (из обеих строк заголовка и tbody)
        const stockColumns = [];

        // Ozon колонка
        const ozonMarketplaceHeader = marketplaceRow.querySelector('.ozon-stock-col');
        const ozonTokenHeader = tokenNameRow.querySelector('.ozon-stock-col');
        if (ozonMarketplaceHeader && ozonTokenHeader) {
            stockColumns.push({
                type: 'ozon',
                marketplaceHeader: ozonMarketplaceHeader,
                tokenHeader: ozonTokenHeader,
                cells: Array.from(rows).map(row => row.querySelector('.ozon-stock-col'))
            });
        }

        // WB колонки
        tokenOrder.filter(t => t.marketplace === 'wildberries').forEach(token => {
            const mpHeader = marketplaceRow.querySelector(`.wb-stock-col[data-token-id="${token.id}"]`);
            const tkHeader = tokenNameRow.querySelector(`.wb-stock-col[data-token-id="${token.id}"]`);
            if (mpHeader && tkHeader) {
                stockColumns.push({
                    type: 'wb',
                    tokenId: token.id,
                    marketplaceHeader: mpHeader,
                    tokenHeader: tkHeader,
                    cells: Array.from(rows).map(row =>
                        row.querySelector(`.wb-stock-col[data-token-id="${token.id}"]`)
                    )
                });
            }
        });

        // Переупорядочиваем колонки согласно порядку токенов
        const orderedColumns = [];
        tokenOrder.forEach(token => {
            if (token.marketplace === 'ozon') {
                const col = stockColumns.find(c => c.type === 'ozon');
                if (col && !orderedColumns.includes(col)) {
                    orderedColumns.push(col);
                }
            } else if (token.marketplace === 'wildberries') {
                const col = stockColumns.find(c => c.type === 'wb' && c.tokenId === token.id);
                if (col && !orderedColumns.includes(col)) {
                    orderedColumns.push(col);
                }
            }
        });

        // Вставляем колонки в правильном порядке (в обе строки заголовка и в tbody)
        orderedColumns.forEach(col => {
            // Перемещаем заголовки маркетплейсов
            marketplaceRow.appendChild(col.marketplaceHeader);
            // Перемещаем заголовки токенов
            tokenNameRow.appendChild(col.tokenHeader);
            // Перемещаем ячейки в tbody
            col.cells.forEach((cell, idx) => {
                if (cell && rows[idx]) {
                    const refCell = rows[idx].querySelector('td.text-center:not(.ozon-stock-col):not(.wb-stock-col)');
                    if (refCell) {
                        rows[idx].insertBefore(cell, refCell);
                    }
                }
            });
        });
    }

    // Инициализация drag and drop
    if (tokenList && tokenItems.length > 0) {
        tokenItems.forEach(item => {
            item.addEventListener('dragstart', function(e) {
                draggedItem = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            item.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                document.querySelectorAll('.token-item').forEach(i => i.classList.remove('drag-over'));
                draggedItem = null;
                saveTokenOrder();
                reorderTableColumns();
            });

            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                if (this !== draggedItem) {
                    this.classList.add('drag-over');
                }
            });

            item.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });

            item.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                if (draggedItem && this !== draggedItem) {
                    const allItems = Array.from(tokenList.querySelectorAll('.token-item'));
                    const draggedIndex = allItems.indexOf(draggedItem);
                    const targetIndex = allItems.indexOf(this);

                    if (draggedIndex < targetIndex) {
                        tokenList.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        tokenList.insertBefore(draggedItem, this);
                    }
                }
            });
        });

        // Применяем сохраненный порядок при загрузке
        applyTokenOrder();
        reorderTableColumns();
    }

    // Функция для получения порядка размера
    function getSizeOrder(size) {
        const sizeOrder = {
            'S': 0, 'M': 1, 'L': 2, 'XL': 3, 'XXL': 4,
            '6': 10, '6.5': 11, '7': 12, '7.5': 13,
            '8': 14, '8.5': 15, '9': 16, '9.5': 17,
            '10': 18, '10.5': 19, '11': 20, '11.5': 21,
            '12': 22, '12.5': 23
        };
        return sizeOrder[size] !== undefined ? sizeOrder[size] : 999;
    }

    // Функция сортировки по артикулу и размеру
    function sortByArticleAndSize() {
        if (!tableBody) return;
        const rows = Array.from(tableBody.querySelectorAll('tr'));
        rows.sort((a, b) => {
            const aArticle = a.dataset.article.toLowerCase();
            const bArticle = b.dataset.article.toLowerCase();
            let result = aArticle.localeCompare(bArticle);
            if (result === 0) {
                const aSize = getSizeOrder(a.dataset.size);
                const bSize = getSizeOrder(b.dataset.size);
                return aSize - bSize;
            }
            return result;
        });
        rows.forEach(row => tableBody.appendChild(row));
    }

    // Сортируем при загрузке страницы
    sortByArticleAndSize();

    // Фильтрация по артикулу
    if (filterInput && tableBody) {
        filterInput.addEventListener('input', function() {
            const filterValue = this.value.toLowerCase().trim();
            const rows = tableBody.querySelectorAll('tr');
            let visibleRows = 0;

            rows.forEach(row => {
                const articleCell = row.querySelector('td:first-child');
                if (articleCell) {
                    const articleText = articleCell.textContent.toLowerCase();

                    // Показываем строку, если артикул начинается с введенного текста
                    if (filterValue === '' || articleText.startsWith(filterValue)) {
                        row.style.display = '';
                        visibleRows++;
                    } else {
                        row.style.display = 'none';
                    }
                }
            });

            // Обновляем счетчик
            if (visibleCount) {
                visibleCount.textContent = visibleRows;
            }
        });

        // Фокус на поле поиска при нажатии Ctrl+F или Cmd+F
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                filterInput.focus();
            }
        });
    }

    // Функция для форматирования даты для API (YYYY-MM-DD)
    function formatDateForAPI(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${year}-${month}-${day}`;
    }

    // Функция для форматирования даты для отображения (DD.MM.YYYY)
    function formatDate(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}.${month}.${year}`;
    }

    // Функция для перезагрузки страницы с новыми датами
    function reloadWithDates(dateFrom, dateTo) {
        const url = new URL(window.location.href);
        if (dateFrom && dateTo) {
            url.searchParams.set('date_from', formatDateForAPI(dateFrom));
            url.searchParams.set('date_to', formatDateForAPI(dateTo));
        } else {
            url.searchParams.delete('date_from');
            url.searchParams.delete('date_to');
        }
        window.location.href = url.toString();
    }

    // Инициализация Air Datepicker
    const picker = new AirDatepicker('#date-range-picker', {
        range: true,
        multipleDatesSeparator: ' - ',
        dateFormat: 'dd.MM.yyyy',
        autoClose: false,
        maxDate: new Date(),
        buttons: [
            {
                content(dp) {
                    return 'Сбросить';
                },
                onClick(dp) {
                    dp.clear();
                    reloadWithDates(null, null);
                }
            },
            {
                content(dp) {
                    return 'Применить';
                },
                onClick(dp) {
                    const dates = dp.selectedDates;
                    if (dates.length === 2) {
                        reloadWithDates(dates[0], dates[1]);
                    } else if (dates.length === 1) {
                        reloadWithDates(dates[0], dates[0]);
                    }
                }
            }
        ]
    });

    // Обработчик кнопки "Все время"
    document.getElementById('reset-dates').addEventListener('click', function() {
        picker.clear();
        reloadWithDates(null, null);
    });

    // Обработчик кнопки "Неделя"
    document.getElementById('reset-to-week').addEventListener('click', function() {
        const today = new Date();
        const weekAgo = new Date();
        weekAgo.setDate(today.getDate() - 6);
        picker.selectDate([weekAgo, today]);
        reloadWithDates(weekAgo, today);
    });

    // Обработчик кнопки "Месяц"
    document.getElementById('reset-to-month').addEventListener('click', function() {
        const today = new Date();
        const monthAgo = new Date();
        monthAgo.setMonth(today.getMonth() - 1);
        picker.selectDate([monthAgo, today]);
        reloadWithDates(monthAgo, today);
    });

    // Сортировка таблицы
    const table = document.querySelector('table');
    const headers = document.querySelectorAll('th.sortable');
    let currentSort = { column: null, direction: 'asc' };

    headers.forEach(header => {
        header.addEventListener('click', function() {
            const sortKey = this.dataset.sort;
            const icon = this.querySelector('i');

            // Определяем направление сортировки
            if (currentSort.column === sortKey) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = sortKey;
                currentSort.direction = 'asc';
            }

            // Сбрасываем иконки на всех заголовках
            headers.forEach(h => {
                const hIcon = h.querySelector('i');
                hIcon.className = 'bi bi-arrow-down-up text-muted';
            });

            // Устанавливаем иконку для текущего столбца
            if (currentSort.direction === 'asc') {
                icon.className = 'bi bi-arrow-up';
            } else {
                icon.className = 'bi bi-arrow-down';
            }

            // Сортируем строки
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                let aVal, bVal;

                if (sortKey === 'article') {
                    aVal = a.dataset.article.toLowerCase();
                    bVal = b.dataset.article.toLowerCase();
                    let result;
                    if (currentSort.direction === 'asc') {
                        result = aVal.localeCompare(bVal);
                    } else {
                        result = bVal.localeCompare(aVal);
                    }
                    // Если артикулы равны, сортируем по размеру
                    if (result === 0) {
                        const aSize = getSizeOrder(a.dataset.size);
                        const bSize = getSizeOrder(b.dataset.size);
                        return aSize - bSize;
                    }
                    return result;
                } else {
                    aVal = parseFloat(a.dataset[sortKey]) || 0;
                    bVal = parseFloat(b.dataset[sortKey]) || 0;
                    let result;
                    if (currentSort.direction === 'asc') {
                        result = aVal - bVal;
                    } else {
                        result = bVal - aVal;
                    }
                    // Если значения равны, сортируем по артикулу
                    if (result === 0) {
                        const aArticle = a.dataset.article.toLowerCase();
                        const bArticle = b.dataset.article.toLowerCase();
                        return aArticle.localeCompare(bArticle);
                    }
                    return result;
                }
            });

            // Перемещаем строки в новом порядке
            rows.forEach(row => tbody.appendChild(row));
        });
    });
});
</script>
{% endblock %}
