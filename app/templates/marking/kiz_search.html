{% extends "base.html" %}

{% block title %}Поиск КИЗ - MarketPlacer{% endblock %}

{% block extra_css %}
<style>
    .search-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .search-box {
        position: relative;
    }

    .search-box .form-control {
        font-size: 1.2rem;
        padding: 0.75rem 1rem;
        padding-right: 45px;
    }

    .search-box .clear-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: none;
        color: #6c757d;
        cursor: pointer;
        display: none;
    }

    .search-box .clear-btn:hover {
        color: #343a40;
    }

    .search-type-selector {
        margin-top: 0.75rem;
    }

    .search-type-selector .form-check {
        display: inline-block;
        margin-right: 1.5rem;
    }

    .results-container {
        margin-top: 1.5rem;
    }

    .result-item {
        padding: 0.75rem 1rem;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        background: #fff;
        transition: background-color 0.15s;
    }

    .result-item:hover {
        background: #f8f9fa;
    }

    .result-folder {
        font-weight: 600;
        color: #0d6efd;
        font-size: 1.1rem;
    }

    .result-folder i {
        margin-right: 0.5rem;
    }

    .result-details {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .result-marking-code {
        font-family: monospace;
        font-size: 0.85rem;
        color: #495057;
        background: #f8f9fa;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        word-break: break-all;
    }

    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
    }

    .no-results {
        display: none;
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }

    .results-count {
        margin-bottom: 1rem;
        color: #6c757d;
    }

    .grouped-results .folder-group {
        margin-bottom: 1rem;
    }

    .grouped-results .folder-header {
        background: #e9ecef;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem 0.375rem 0 0;
        font-weight: 600;
        color: #495057;
    }

    .grouped-results .folder-items {
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
    }

    .grouped-results .folder-item {
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .grouped-results .folder-item:last-child {
        border-bottom: none;
    }

    .highlight {
        background-color: #fff3cd;
        padding: 0 2px;
        border-radius: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="search-container">
        <h2 class="mb-4"><i class="bi bi-search"></i> Поиск КИЗ</h2>

        <div class="search-box">
            <input type="text" class="form-control" id="searchInput"
                   placeholder="Введите артикул или код маркировки..." autofocus>
            <button type="button" class="clear-btn" id="clearBtn">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <div class="search-type-selector">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="searchType" id="typeArticle" value="article" checked>
                <label class="form-check-label" for="typeArticle">
                    По артикулу (начало)
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="searchType" id="typeMarkingCode" value="marking_code">
                <label class="form-check-label" for="typeMarkingCode">
                    По коду маркировки (любая часть)
                </label>
            </div>
        </div>

        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-2">Поиск...</p>
        </div>

        <div class="no-results" id="noResults">
            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
            <p class="mt-2">Ничего не найдено</p>
        </div>

        <div class="results-container" id="resultsContainer">
            <div class="results-count" id="resultsCount"></div>
            <div id="resultsList"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const noResults = document.getElementById('noResults');
    const resultsContainer = document.getElementById('resultsContainer');
    const resultsCount = document.getElementById('resultsCount');
    const resultsList = document.getElementById('resultsList');

    let searchTimeout = null;
    let currentRequest = null;

    function getSearchType() {
        return document.querySelector('input[name="searchType"]:checked').value;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function highlightText(text, query) {
        if (!query) return escapeHtml(text);
        const escaped = escapeHtml(text);
        const regex = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
        return escaped.replace(regex, '<span class="highlight">$1</span>');
    }

    function showLoading() {
        loadingSpinner.style.display = 'block';
        noResults.style.display = 'none';
        resultsContainer.style.display = 'none';
    }

    function hideLoading() {
        loadingSpinner.style.display = 'none';
    }

    function showNoResults() {
        hideLoading();
        noResults.style.display = 'block';
        resultsContainer.style.display = 'none';
    }

    function showResults(data, query) {
        hideLoading();
        noResults.style.display = 'none';
        resultsContainer.style.display = 'block';

        const searchType = getSearchType();

        if (searchType === 'article') {
            // Группируем по папке для поиска по артикулу
            const grouped = {};
            data.forEach(item => {
                if (!grouped[item.folder]) {
                    grouped[item.folder] = [];
                }
                grouped[item.folder].push(item);
            });

            const foldersCount = Object.keys(grouped).length;
            resultsCount.textContent = `Найдено: ${data.length} позиций в ${foldersCount} папках`;

            let html = '<div class="grouped-results">';
            Object.keys(grouped).sort().forEach(folder => {
                const items = grouped[folder];
                html += `
                    <div class="folder-group">
                        <div class="folder-header">
                            <i class="bi bi-folder-fill"></i> ${escapeHtml(folder)}
                            <span class="badge bg-secondary ms-2">${items.length}</span>
                        </div>
                        <div class="folder-items">
                `;
                items.forEach(item => {
                    html += `
                        <div class="folder-item">
                            <span class="text-muted">Артикул:</span> <strong>${highlightText(item.article, query)}</strong>
                            ${item.size ? `<span class="ms-2 text-muted">Размер:</span> ${escapeHtml(item.size)}` : ''}
                            <span class="ms-2 text-muted">GTIN:</span> <code>${escapeHtml(item.gtin)}</code>
                            <span class="ms-2 badge bg-primary">${item.count} шт.</span>
                        </div>
                    `;
                });
                html += '</div></div>';
            });
            html += '</div>';

            resultsList.innerHTML = html;
        } else {
            // Для поиска по коду маркировки показываем все найденные коды
            resultsCount.textContent = `Найдено: ${data.length} кодов маркировки`;

            let html = '';
            data.forEach(item => {
                html += `
                    <div class="result-item">
                        <div class="result-folder">
                            <i class="bi bi-folder-fill"></i> ${escapeHtml(item.folder)}
                            <span class="ms-2 badge bg-secondary">строка ${item.line_number}</span>
                        </div>
                        <div class="result-marking-code mt-2">
                            ${highlightText(item.marking_code, query)}
                        </div>
                        <div class="result-details mt-1">
                            ${item.article ? `<span>Артикул: <strong>${escapeHtml(item.article)}</strong></span>` : ''}
                            ${item.size ? `<span class="ms-2">Размер: ${escapeHtml(item.size)}</span>` : ''}
                            ${item.gtin ? `<span class="ms-2">GTIN: <code>${escapeHtml(item.gtin)}</code></span>` : ''}
                        </div>
                    </div>
                `;
            });

            resultsList.innerHTML = html;
        }
    }

    function clearResults() {
        resultsContainer.style.display = 'none';
        noResults.style.display = 'none';
        resultsList.innerHTML = '';
        resultsCount.textContent = '';
    }

    function performSearch() {
        const query = searchInput.value.trim();
        const searchType = getSearchType();

        // Показываем/скрываем кнопку очистки
        clearBtn.style.display = query ? 'block' : 'none';

        if (!query) {
            clearResults();
            hideLoading();
            return;
        }

        showLoading();

        // Отменяем предыдущий запрос если есть
        if (currentRequest) {
            currentRequest.abort();
        }

        const controller = new AbortController();
        currentRequest = controller;

        fetch(`/marking/api/search-kiz?query=${encodeURIComponent(query)}&type=${searchType}`, {
            signal: controller.signal
        })
        .then(response => response.json())
        .then(data => {
            currentRequest = null;
            if (data.success) {
                if (data.data.length === 0) {
                    showNoResults();
                } else {
                    showResults(data.data, query);
                }
            } else {
                hideLoading();
                alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            currentRequest = null;
            if (error.name !== 'AbortError') {
                hideLoading();
                console.error('Search error:', error);
            }
        });
    }

    // Обработка ввода с debounce
    searchInput.addEventListener('input', function() {
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        searchTimeout = setTimeout(performSearch, 300);
    });

    // Обработка смены типа поиска
    document.querySelectorAll('input[name="searchType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (searchInput.value.trim()) {
                performSearch();
            }
        });
    });

    // Кнопка очистки
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        clearBtn.style.display = 'none';
        clearResults();
        searchInput.focus();
    });

    // Enter для поиска
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            performSearch();
        }
    });
});
</script>
{% endblock %}
